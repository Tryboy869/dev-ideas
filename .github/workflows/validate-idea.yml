name: Validate Idea JSON

on:
  pull_request:
    paths:
      - 'ideas/**/*.json'
  push:
    branches: [main]
    paths:
      - 'ideas/**/*.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install validation tools
        run: npm install -g ajv-cli ajv-formats

      - name: Validate JSON structure
        run: |
          echo "üìã Validating all idea JSON files..."
          ajv validate \
            -s schema/idea.schema.json \
            -d "ideas/*.json" \
            --spec=draft7 \
            --strict=false \
            --all-errors
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ All JSON files are valid!"
          else
            echo "‚ùå Validation failed. Check errors above."
            exit 1
          fi

      - name: Check for duplicate IDs
        run: |
          echo "üîç Checking for duplicate idea IDs..."
          DUPLICATES=$(jq -r '.id' ideas/*.json | sort | uniq -d)
          
          if [ -n "$DUPLICATES" ]; then
            echo "‚ùå Duplicate IDs found:"
            echo "$DUPLICATES"
            exit 1
          else
            echo "‚úÖ No duplicate IDs found!"
          fi

      - name: Validate PoC/Validated status has proofs
        run: |
          echo "üîó Checking that PoC/Validated ideas have proof links..."
          for file in ideas/*.json; do
            STATUS=$(jq -r '.status' "$file")
            PROOFS=$(jq '.proofs | length' "$file")
            
            if [[ "$STATUS" == "poc" || "$STATUS" == "validated" ]]; then
              if [[ "$PROOFS" -eq 0 || "$PROOFS" == "null" ]]; then
                echo "‚ùå $file has status '$STATUS' but no proofs!"
                exit 1
              fi
            fi
          done
          echo "‚úÖ All PoC/Validated ideas have proofs!"

      - name: Auto-label PR if valid
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['auto-approved', 'valid-json']
            });

      - name: Check proof repository naming convention
        if: success()
        run: |
          echo "üè∑Ô∏è  Checking proof repository naming..."
          for file in ideas/*.json; do
            PROOFS=$(jq -r '.proofs[]? | select(.type == "github" or .type == "gitlab") | .url' "$file" 2>/dev/null || echo "")
            
            if [ -n "$PROOFS" ]; then
              while IFS= read -r url; do
                if [ -z "$url" ]; then
                  continue
                fi
                REPO_NAME=$(echo "$url" | sed -E 's|.*/([^/]+)$|\1|')
                if [[ ! "$REPO_NAME" =~ ^devideas- ]]; then
                  echo "‚ö†Ô∏è  Warning: Proof repo '$REPO_NAME' should be prefixed with 'devideas-'"
                  echo "   URL: $url"
                  echo "   This will be enforced after merge."
                fi
              done <<< "$PROOFS"
            fi
          done

      - name: Comment success on PR
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ **Validation passed!** Your idea JSON is structurally correct.

**Next steps:**
1. A maintainer will review the content
2. Once merged:
   - A Discussion thread will be created automatically
   - Add the [/dev/ideas badge](https://tryboy869.github.io/dev-ideas/badges.html) to your proof repositories
   - **Prefix your proof repos with \`devideas-\`** (e.g., \`devideas-my-project\`)
   
See [badges documentation](https://tryboy869.github.io/dev-ideas/badges.html) for details.`
            });
